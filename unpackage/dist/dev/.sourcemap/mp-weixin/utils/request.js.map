{"version":3,"file":"request.js","sources":["utils/request.js"],"sourcesContent":["const domain = 'https://duoxie.cc.cd/mazu';\r\nexport const base_url = `${domain}:${wx.getSystemInfoSync().platform === 'devtools' ? 8899 : 6869}`;\r\nexport const ai_base_url = 'http://127.0.0.1:8080';\r\nconst timeout = 50000;\r\n\r\nconst aiWhiteList = ['/user/user/chat', '/user/image/generateimg', '/user/image/mazuCarousel'];\r\n\r\nfunction isAiWhiteList(url) {\r\n\treturn aiWhiteList.includes(url);\r\n}\r\n\r\nexport default (params) => {\r\n\tlet url = params.url;\r\n\tlet method = (params.method || \"get\").toLowerCase();\r\n\tlet data = params.data || {};\r\n\r\n\t// 核心修改：强制AI白名单接口走ai_base_url，无视useAiUrl参数\r\n\tconst finalBaseUrl = isAiWhiteList(url) ? ai_base_url : domain;\r\n\r\n\tconst token = uni.getStorageSync('token');\r\n\tlet header = {\r\n\t\t'Content-Type': 'application/json;charset=UTF-8',\r\n\t\t'Tenant-Id': uni.getStorageSync('tenantId') || 'xxx',\r\n\t\t...params.header // 外部传入的头优先\r\n\t};\r\n\r\n\t// 非AI白名单接口：添加Token头（保留原有认证逻辑）\r\n\tif (!isAiWhiteList(url)) {\r\n\t\theader['Blade-Auth'] = token || '';\r\n\t\theader['Authorization'] = token || '';\r\n\t}\r\n\r\n\t// ========== 修复：POST请求头不覆盖AI接口的自定义头 ==========\r\n\tif (method === \"post\" && !isAiWhiteList(url)) { // AI接口的POST不覆盖头\r\n\t\theader = {\r\n\t\t\t'Content-Type': 'application/json'\r\n\t\t};\r\n\t}\r\n\r\n\t// 调试：打印关键信息，方便排查\r\n\tconsole.log('===== 请求调试信息 =====');\r\n\tconsole.log('请求地址:', finalBaseUrl + url); // 验证是否为127.0.0.1:8080\r\n\tconsole.log('是否为AI接口:', isAiWhiteList(url)); // 验证是否命中白名单\r\n\tconsole.log('是否免Token:', isAiWhiteList(url));\r\n\tconsole.log('请求头:', header);\r\n\r\n\treturn new Promise((resolve, reject) => {\r\n\t\t// 移除：uni.showLoading 加载框\r\n\t\tuni.request({\r\n\t\t\turl: finalBaseUrl + url,\r\n\t\t\tmethod: method,\r\n\t\t\theader: header,\r\n\t\t\tdata: data,\r\n\t\t\ttimeout,\r\n\t\t\tsuccess(response) {\r\n\t\t\t\tif (response.statusCode == 200) {\r\n\t\t\t\t\tresolve(response.data);\r\n\t\t\t\t} else {\r\n\t\t\t\t\t// 优化：AI接口401不弹登录提示（免Token接口无需登录）\r\n\t\t\t\t\tif (response.statusCode === 401 && isAiWhiteList(url)) {\r\n\t\t\t\t\t\tuni.showToast({\r\n\t\t\t\t\t\t\ttitle: 'AI接口请求失败，无需登录',\r\n\t\t\t\t\t\t\ticon: 'none',\r\n\t\t\t\t\t\t\tduration: 2000\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tswitch (response.statusCode) {\r\n\t\t\t\t\t\t\tcase 401:\r\n\t\t\t\t\t\t\t\tuni.showModal({\r\n\t\t\t\t\t\t\t\t\ttitle: \"提示\",\r\n\t\t\t\t\t\t\t\t\tcontent: \"请登录\",\r\n\t\t\t\t\t\t\t\t\tshowCancel: false\r\n\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\tcase 404:\r\n\t\t\t\t\t\t\t\tuni.showToast({\r\n\t\t\t\t\t\t\t\t\ttitle: '请求地址不存在...',\r\n\t\t\t\t\t\t\t\t\tduration: 2000\r\n\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\tdefault:\r\n\t\t\t\t\t\t\t\tuni.showToast({\r\n\t\t\t\t\t\t\t\t\ttitle: `请求错误：${response.statusCode}`,\r\n\t\t\t\t\t\t\t\t\ticon: 'none',\r\n\t\t\t\t\t\t\t\t\tduration: 2000\r\n\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\treject(response);\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\tfail(err) {\r\n\t\t\t\tconsole.error('请求失败详情:', err);\r\n\t\t\t\t// 修复：小程序error图标兼容问题，统一用none\r\n\t\t\t\tif (err.errMsg.indexOf('request:fail') !== -1) {\r\n\t\t\t\t\tuni.showToast({\r\n\t\t\t\t\t\ttitle: '网络异常，请检查连接',\r\n\t\t\t\t\t\ticon: \"none\",\r\n\t\t\t\t\t\tduration: 2000\r\n\t\t\t\t\t});\r\n\t\t\t\t} else if (err.errMsg.includes('timeout')) {\r\n\t\t\t\t\tuni.showToast({\r\n\t\t\t\t\t\ttitle: '请求超时，请稍后重试',\r\n\t\t\t\t\t\ticon: \"none\",\r\n\t\t\t\t\t\tduration: 2000\r\n\t\t\t\t\t});\r\n\t\t\t\t} else {\r\n\t\t\t\t\tuni.showToast({\r\n\t\t\t\t\t\ttitle: '未知异常',\r\n\t\t\t\t\t\ticon: \"none\",\r\n\t\t\t\t\t\tduration: 2000\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t\treject(err);\r\n\t\t\t},\r\n\t\t\tcomplete() {\r\n\t\t\t\t// 移除：uni.hideLoading 加载框关闭\r\n\t\t\t}\r\n\t\t});\r\n\t}).catch(() => {\r\n\t\t// 移除：catch中的uni.hideLoading\r\n\t});\r\n};"],"names":["wx","uni"],"mappings":"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"}